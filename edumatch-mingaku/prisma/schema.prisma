generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

model Profile {
  id                              String            @id @db.Uuid
  role                            Role              @default(VIEWER)
  name                            String
  email                           String            @unique
  avatar_url                      String?
  subscription_status             String            @default("INACTIVE")
  created_at                      DateTime          @default(now())
  updated_at                      DateTime          @updatedAt
  address                         String?
  city                            String?
  phone                           String?
  postal_code                     String?
  prefecture                      String?
  bio                             String?
  website                         String?
  subscription_plan               String?
  stripe_customer_id              String?           @unique
  stripe_subscription_id          String?
  subscription_current_period_end DateTime?
  /// チャット利用履歴（24時間ローリング） [{ mode, at }] at は ISO 文字列
  chat_usage_events                Json?
  material_requests               MaterialRequest[]
  posts                           Post[]
  reviews                         Review[]
  services                        Service[]
  view_histories                  ViewHistory[]
  chat_sessions                   ChatSession[]

  @@index([email])
  @@index([stripe_customer_id])
}

model MaterialRequest {
  id                   String   @id @default(cuid())
  user_id              String   @db.Uuid
  service_id           String
  use_account_address  Boolean
  delivery_name        String
  delivery_phone       String?
  delivery_postal_code String?
  delivery_prefecture  String?
  delivery_city        String?
  delivery_address     String?
  delivery_email       String
  message              String?
  created_at           DateTime @default(now())
  service              Service  @relation(fields: [service_id], references: [id], onDelete: Cascade)
  user                 Profile  @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([service_id])
}

model ViewHistory {
  id           String   @id @default(cuid())
  user_id      String   @db.Uuid
  content_type String
  content_id   String
  viewed_at    DateTime @default(now())
  user         Profile  @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@unique([user_id, content_type, content_id])
  @@index([user_id])
}

/// AIチャットの会話セッション（履歴保存用）
model ChatSession {
  id         String   @id @default(cuid())
  user_id    String   @db.Uuid
  /// 会話のタイトル（最初のユーザーメッセージ、最大60文字）
  title      String   @default("")
  /// 使用モード "fast" | "balance" | "thinking"
  mode       String   @default("fast")
  /// メッセージ配列 [{ id, role, content }]
  messages   Json     @default("[]")
  created_at DateTime @default(now())
  updated_at DateTime @updatedAt
  user       Profile  @relation(fields: [user_id], references: [id], onDelete: Cascade)

  @@index([user_id])
  @@index([user_id, created_at(sort: Desc)])
}

model Service {
  id                    String            @id @default(cuid())
  provider_id           String            @db.Uuid
  title                 String
  description           String
  content               String
  thumbnail_url         String?
  category              String
  price_info            String
  is_published          Boolean           @default(false)
  created_at            DateTime          @default(now())
  updated_at            DateTime          @updatedAt
  images                String[]
  youtube_url           String?
  approved_at           DateTime?
  rejected_at           DateTime?
  rejection_reason      String?
  status                PublishStatus     @default(DRAFT)
  submitted_at          DateTime?
  is_member_only        Boolean           @default(false)
  view_count            Int               @default(0)
  favorite_count        Int               @default(0)
  request_count         Int               @default(0)
  tags                  String[]          @default([])
  sort_order            Int               @default(9999)
  /// 表示用提供者名。未設定時は provider.name
  provider_display_name String?
  /// WooCommerce product (post) ID。XML とのマッチ・再インポート用
  wp_product_id         Int?
  /// 口コミ数（非正規化キャッシュ）
  review_count          Int               @default(0)
  material_requests     MaterialRequest[]
  reviews               Review[]
  provider              Profile           @relation(fields: [provider_id], references: [id], onDelete: Cascade)

  @@index([provider_id])
  @@index([category])
  @@index([status])
  @@index([favorite_count])
  @@index([request_count])
  @@index([review_count])
  @@index([sort_order, created_at(sort: Desc)], map: "service_sort_order_idx")
}

/// サービスへの口コミ・レビュー
model Review {
  id            String   @id @default(cuid())
  service_id    String
  /// ログインユーザーのID（ゲスト投稿は null）
  user_id       String?  @db.Uuid
  /// 投稿者表示名
  author_name   String
  /// 評価（1〜5）。旧コメントは null
  rating        Int?
  /// レビュー本文
  body          String
  /// 承認済みか
  is_approved   Boolean  @default(true)
  /// WordPress コメントID（重複インポート防止）
  wp_comment_id Int?
  created_at    DateTime @default(now()) @db.Timestamptz(6)
  service       Service  @relation(fields: [service_id], references: [id], onDelete: Cascade, onUpdate: NoAction)
  user          Profile? @relation(fields: [user_id], references: [id], onUpdate: NoAction)

  @@index([service_id])
  @@index([user_id])
  @@index([created_at(sort: Desc)])
}

model Post {
  id                  String             @id @default(cuid())
  provider_id         String             @db.Uuid
  title               String
  content             String
  thumbnail_url       String?
  view_count          Int                @default(0)
  is_published        Boolean            @default(false)
  created_at          DateTime           @default(now())
  updated_at          DateTime           @updatedAt
  images              String[]
  youtube_url         String?
  approved_at         DateTime?
  rejected_at         DateTime?
  rejection_reason    String?
  status              PublishStatus      @default(DRAFT)
  submitted_at        DateTime?
  is_member_only      Boolean            @default(false)
  favorite_count      Int                @default(0)
  category            String             @default("教育ICT")
  summary             String?
  tags                String[]
  /// WordPress post_id。再インポート時にマッチし、favorite_count を引き継ぐ
  wp_post_id          Int?
  /// CSV/WordPress の著者表示名。未設定時は provider.name を使用
  author_display_name String?
  home_slider_entries HomeSliderArticle?
  provider            Profile            @relation(fields: [provider_id], references: [id], onDelete: Cascade)

  @@index([provider_id])
  @@index([category])
  @@index([status])
  @@index([favorite_count])
}

/// 運営情報（サイト更新情報）。WordPress インポートまたは手動登録。
model SiteUpdate {
  id            String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  title         String
  body          String   @default("")
  excerpt       String?
  published_at  DateTime @db.Timestamptz(6)
  link          String?
  wp_post_id    Int?     @unique
  thumbnail_url String?
  category      String?
  created_at    DateTime @default(now()) @db.Timestamptz(6)
  updated_at    DateTime @default(now()) @updatedAt @db.Timestamptz(6)

  @@index([published_at(sort: Desc)])
}

/// トップスライダーに表示する記事（ADMINが選択）。表示順は position の昇順。
model HomeSliderArticle {
  id         String   @id @default(dbgenerated("(gen_random_uuid())::text"))
  post_id    String   @unique
  position   Int      @default(0)
  created_at DateTime @default(now()) @db.Timestamptz(6)
  post       Post     @relation(fields: [post_id], references: [id], onDelete: Cascade, onUpdate: NoAction)

  @@index([position])
}

/// 記事・サービスの固定カテゴリマスター（22個の大カテゴリ）
/// Post.category / Service.category はこのテーブルの name を参照
/// タグ（Post.tags / Service.tags）は別途自由入力の配列として管理
model ArticleCategory {
  id        String   @id @default(dbgenerated("gen_random_uuid()")) @db.Uuid
  name      String   @unique
  slug      String?
  sortOrder Int      @default(0) @map("sort_order")
  createdAt DateTime @default(now()) @map("created_at") @db.Timestamptz(6)
  updatedAt DateTime @default(now()) @updatedAt @map("updated_at") @db.Timestamptz(6)

  @@index([sortOrder])
  @@index([name])
}

/// セミナー・イベント情報。WordPress seminar_event カスタム投稿タイプからインポート。
model SeminarEvent {
  id           String   @id @default(cuid())
  title        String
  description  String   @default("")
  event_date   String?               /// イベント開催日 YYYY-MM-DD 文字列
  venue        String?               /// 開催場所
  company      String?               /// 主催者
  external_url String?               /// 詳細・申込URL
  wp_post_id   Int?     @unique      /// WordPress post_id（重複インポート防止）
  wp_link      String?               /// WordPress 元ページURL
  created_at   DateTime @default(now())
  updated_at   DateTime @updatedAt

  @@index([event_date])
  @@index([wp_post_id])
}

enum Role {
  ADMIN
  PROVIDER
  VIEWER
}

enum PublishStatus {
  DRAFT
  PENDING
  APPROVED
  REJECTED
}
