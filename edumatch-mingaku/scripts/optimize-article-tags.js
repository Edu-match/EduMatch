/**
 * 記事タグの最適化
 * - 年・年度の統一（2025年 → 2025年度）
 * - 表記ゆれの統合（eduplus+ → eduplus など）
 * - 個人名・過度に細かいタグの除外
 * - 年度付きイベント名の統合（〇〇2025 → 〇〇）
 */

const fs = require("fs");
const path = require("path");

const inputPath = path.join(__dirname, "../data/article-tags-sorted.txt");
const raw = fs.readFileSync(inputPath, "utf-8");
let tags = raw.split("\n").map((s) => s.trim()).filter(Boolean);

// 最終目標: 15〜20個の大カテゴリに絞り込み
// 最終カテゴリ候補:
// AI, ICT, 教育, 塾, 学習, 受験, 小学校, 中学, 高校, 大学, 英語, プログラミング, 
// オンライン, セミナー, 保護者, 教員, 教材, 補助金, 地域, その他

// 1. 正規化マップ（左→右に統一。統合後は右だけ残る）※15〜20個に大統合
const normalizeMap = {
  // 年・年度
  "2025年": "2025年度",
  "2025年教育": "2025年度",
  // 表記ゆれ
  "eduplus+": "eduplus",
  "慶応義塾大学": "慶應大学",
  "主体的な学び": "主体的学び",
  "情報１": "情報Ⅰ",
  "教育A活用協会": "教育AI活用協会",
  "教育AIサミット2025": "教育AIサミット",
  "教育AIサミット2026": "教育AIサミット",
  "セミナー、イベント告知": "セミナー・イベント",
  "EXPO2025大阪・関西万博": "EXPO2025",
  "中学生学習サポート": "中学生",
  "小学生学習ツール": "小学生",
  "塾の先生向け": "塾の先生",
  "学習意欲の向上": "学習意欲",
  // AI関連 → 代表タグに集約
  "AIアバター": "AI活用",
  "AIアプリ": "AI活用",
  "AIエージェント": "AI活用",
  "AIエンジニア": "AI活用",
  "AIコンサルタント": "AI活用",
  "AIコンテンツ制作": "AI活用",
  "AIサンタ": "AI",
  "AIセミナー": "AI活用",
  "AIソリューション": "AI活用",
  "AIチャット": "AI活用",
  "AIチャンピオンシップ": "AI",
  "AIチューター": "AI教育",
  "AIツール": "AI活用",
  "AIデータ": "AI活用",
  "AIなりすまし": "AI",
  "AIの使用例": "AI活用",
  "AIハッカソン": "AI",
  "AIメンタリングシステム": "AI教育",
  "AIモード": "AI",
  "AIリスク": "AI",
  "AIリテラシー": "AI教育",
  "AI映像分析": "AI活用",
  "AI英語教育": "AI教育",
  "AI学習支援": "AI教育",
  "AI共育ラボ": "AI教育",
  "AI教育プログラム": "AI教育",
  "AI教育活用": "AI教育",
  "AI教材": "AI教育",
  "AI効率化": "AI活用",
  "AI講師": "AI教育",
  "AI採点": "AI教育",
  "AI時代の教育": "AI教育",
  "AI失敗談": "AI活用",
  "AI成功事例": "AI活用",
  "AI先生": "AI教育",
  "AI戦略": "AI活用",
  "AI通訳機": "AI活用",
  "AI統合": "AI活用",
  "AI導入": "AI活用",
  "AI導入の課題": "AI活用",
  "AI部": "AI",
  "AI面接官": "AI活用",
  "生成AI": "AI",
  "生成AIガイドライン": "AI活用",
  "生成AI協会": "AI",
  "生成AI活用": "AI活用",
  "生成AI記事": "AI",
  "教育AI": "AI教育",
  "教育AI活用協会": "AI教育",
  // ICT/IT
  "ICTツール": "ICT活用",
  "ICT運用支援": "ICT活用",
  "ICT学習": "ICT活用",
  "ICT活用教育": "ICT活用",
  "ICT教育": "教育ICT",
  "ICT教材": "ICT活用",
  "ICT導入支援": "ICT活用",
  "ITリテラシー": "ICT活用",
  "IT活用": "ICT活用",
  "IT導入補助金": "補助金",
  // オンライン系
  "オンラインコース": "オンライン学習",
  "オンラインサロン": "オンライン",
  "オンラインセミナー": "オンライン",
  "オンライン勉強会": "オンライン学習",
  "オンライン化": "オンライン",
  "オンライン学習塾": "オンライン学習",
  "オンライン対応": "オンライン",
  "オンライン指導": "オンライン授業",
  "オンライン授業支援": "オンライン授業",
  "オンライン教育": "オンライン学習",
  "オンライン自習室": "オンライン学習",
  "オンライン英会話": "英会話",
  "リモート学習": "オンライン学習",
  "リモート学習支援": "オンライン学習",
  // 塾・経営系
  "塾カリキュラム再設計": "塾経営",
  "塾サイトの選び方": "集客",
  "塾向けICT": "ICT活用",
  "塾向けICT教材": "教材",
  "塾向けシステム": "塾運営",
  "塾指導": "塾運営",
  "塾教師養成": "講師研修",
  "塾教育": "塾運営",
  "塾教育の新しいアプローチ": "塾経営",
  "塾業界": "塾経営",
  "塾業界の連携": "塾経営",
  "塾業界動向": "塾経営",
  "塾管理システム": "塾運営",
  "塾管理ツール": "塾運営",
  "塾講師サポート": "講師研修",
  "塾講師研修": "講師研修",
  "塾運営支援": "塾運営",
  "塾開校": "塾経営",
  "学習塾イノベーション": "塾経営",
  "学習塾ポータル": "集客",
  "学習塾利益": "塾経営",
  "学習塾成功事例": "塾経営",
  "学習塾経営": "塾経営",
  "学習塾規制": "塾経営",
  "入塾率アップ": "集客",
  "入塾面談のポイント": "面談",
  // 教育系の細分化を集約
  "教育の公平性": "教育改革",
  "教育の未来": "教育",
  "教育の未来AI": "AI教育",
  "教育の質": "教育",
  "教育アプローチ": "教育",
  "教育カリキュラム": "教育",
  "教育コミュニケーションフォーラム": "教育",
  "教育コンサル": "教育",
  "教育コンサルティング": "教育",
  "教育コンテンツ": "教材",
  "教育コーチング": "教育",
  "教育コーチングEdcoac": "教育",
  "教育コーチングの基本": "教育",
  "教育コーチング動画": "教育",
  "教育サービスの質": "教育",
  "教育サービス導入": "教育",
  "教育サービス開発": "教育",
  "教育システム": "教育",
  "教育センター": "教育",
  "教育ソリューション": "教育",
  "教育ツール": "教育",
  "教育テクノロジー": "教育ICT",
  "教育トレンド": "教育",
  "教育ニーズ": "教育",
  "教育ノウハウ": "教育",
  "教育ビジネス": "塾経営",
  "教育プログラム": "教育",
  "教育プログラムの革新": "教育改革",
  "教育ベンチャー": "教育",
  "教育マーケティング": "集客",
  "教育事業": "教育",
  "教育品質向上": "教育",
  "教育委員会": "教育",
  "教育安全": "教育",
  "教育市場": "塾経営",
  "教育成功": "教育",
  "教育戦略": "教育",
  "教育技術": "教育",
  "教育投資": "教育",
  "教育指導": "教育",
  "教育改革": "教育改革",
  "教育政策影響": "教育",
  "教育方法": "教育",
  "教育格差": "教育",
  "教育業界の洞察": "塾経営",
  "教育業界ストレス": "塾経営",
  "教育業界動向": "塾経営",
  "教育現場でのコーチング": "教育",
  "教育環境": "教育",
  "教育環境改善": "教育",
  "教育経済": "教育",
  "教育虐待": "教育",
  "教育費削減": "教育",
  "教育資金": "教育",
  "教育質向上": "教育",
  "教育革命": "教育改革",
  // 学習・教材
  "学習の目的": "学習",
  "学習アプリ": "学習",
  "学習サポート": "学習支援",
  "学習システム": "学習",
  "学習モチベーション": "学習",
  "学習効率": "学習",
  "学習効率化": "学習",
  "学習動機": "学習",
  "学習定着": "学習",
  "学習指導": "学習",
  "学習支援ツール": "学習支援",
  "学習方法の革新": "教育改革",
  "学習最適化": "学習",
  "学習用端末": "ICT活用",
  "学習管理": "学習",
  "学習記録出力": "学習",
  "学習進捗管理": "学習",
  "家庭学習サポート": "家庭学習",
  "自宅学習サポート": "家庭学習",
  "デジタル教材": "教材",
  "映像教材": "教材",
  "テスト対策教材": "教材",
  "教材更新": "教材",
  "教材選び": "教材",
  "中学生教材": "教材",
  // 保護者・生徒
  "保護者との信頼関係": "保護者対応",
  "保護者との連携": "保護者連携",
  "保護者の不安": "保護者対応",
  "保護者意識": "保護者対応",
  "保護者支援": "保護者対応",
  "保護者教育": "保護者対応",
  "生徒とのエンゲージメント": "生徒指導",
  "生徒とのコミュニケーション": "生徒指導",
  "生徒と教師の関係": "生徒指導",
  "生徒のやる気": "生徒指導",
  "生徒の学び意識": "生徒指導",
  "生徒の話を聴く": "生徒指導",
  "生徒サポート": "生徒指導",
  "生徒モチベーション": "生徒指導",
  "生徒個別対応": "個別指導",
  "生徒募集": "集客",
  "生徒募集戦略": "集客",
  "生徒所見": "生徒指導",
  "生徒指導法": "生徒指導",
  "生徒支援": "生徒指導",
  "生徒支援の最適化": "生徒指導",
  "生徒数拡大": "集客",
  "生徒数維持": "塾経営",
  "生徒管理": "塾運営",
  "生徒集客": "集客",
  // 講師・教員
  "教員の業務負担": "教員研修",
  "教員メンタルヘルス": "教員研修",
  "教員休職対策": "教員研修",
  "教員働き方改革": "教員研修",
  "教員負担": "教員研修",
  "教員負担軽減": "教員研修",
  "教師と生徒の関係": "教師研修",
  "教師の人間力": "教師研修",
  "教師の成長": "教師研修",
  "教師インターンシップ": "講師採用",
  "教師労働環境": "教師研修",
  "教師向けAIツール": "AI教育",
  "教師研修プログラム": "教師研修",
  "講師環境改善": "講師研修",
  "講師用マニュアル": "講師研修",
  "講師研修の方法": "講師研修",
  "講師管理": "塾運営",
  // 集客・マーケ
  "集客アイデア": "集客",
  "集客戦略": "集客",
  "集客支援": "集客",
  "集客方法": "集客",
  "SNSマーケティング": "SNS",
  "SNS集客": "SNS",
  "WEB集客": "集客",
  "新規生徒獲得": "集客",
  // 面談・受験
  "三者面談": "面談",
  "入試対策": "受験対策",
  "入試改革": "受験",
  "入試環境": "受験",
  "受験うつ": "受験",
  "受験の偏差値": "受験",
  "受験勉強": "受験対策",
  "受験成功": "受験",
  "受験指導": "受験対策",
  "受験生の志望理由": "受験",
  "受験生指導": "受験対策",
  "受験費用補助": "補助金",
  "受験軸": "受験",
  "志望校のきっかけ": "受験",
  "志望理由書": "受験",
  // 補助金・制度
  "補助プログラム": "補助金",
  "補助金活用": "補助金",
  "業務改善助成金": "補助金",
  "模試費用補助": "補助金",
  "授業料実質無償化": "補助金",
  // その他よく使う統合
  "GIGAスクール構想": "GIGAスクール",
  "GIGAスクール構想第2期": "GIGAスクール",
  "ZOOMセミナー": "オンライン",
  "コミュニケーションスキル": "コミュニケーション",
  "コミュニケーション強化": "コミュニケーション",
  "コミュニケーション能力": "コミュニケーション",
  "効果的な学び": "学習",
  "効果的な指導法": "指導方法",
  "効果的な教育研修": "教員研修",
  "効率的な塾運営": "塾運営",
  "効率的学習": "学習",
  "成功事例活用": "成功事例",
  "成績アップ事例": "成功事例",
  "成績向上": "学習",
  "探究学習": "探究教育",
  "探究学習支援": "探究教育",
  "探究授業": "探究教育",
  "探究サービス": "探究教育",
  "探求学習": "探究教育",
  "主体的学び": "主体的な学び",
  "個別学習AI": "AI教育",
  "個別指導の秘訣": "個別指導",
  "個別指導塾LEADEST": "個別指導塾",
  "個別指導強化": "個別指導",
  "教室でのAI活用": "AI活用",
  "教室運営": "塾運営",
  "学校と塾の協働": "学校連携",
  "学校と家庭の連携": "保護者連携",
  "学校ICT": "教育ICT",
  "学校DX戦略アドバイザー": "教育ICT",
  "学校教材": "教材",
  "学校管理職": "教育",
  "学校連携": "教育",
  "校務DX": "教育ICT",
  "校務効率化": "教育ICT",
  "受験対策超越": "受験対策",
  "試験対策": "受験対策",
  "手書き": "教材",
  "天神教材": "教材",
  "教科書ナビ": "教材",
  "教科書改訂": "教材",
  "教科書準拠": "教材",
  "検定教科書準拠": "教材",
  "小学校教科書": "教材",
  "問題演習": "教材",
  "反復学習": "学習",
  "繰り返し学習": "学習",
  "自学自習": "学習",
  "自立型": "学習",
  "能動的学習": "学習",
  "理解促進": "学習",
  "速読": "学習",
  "多読多聴": "英語",
  "英語4技能": "英語",
  "英語リーディング": "英語",
  "英語学習": "英語",
  "英語学習法": "英語",
  "英語教室": "英語",
  "英語検定": "英語",
  "英語講師不要": "英語",
  "英語資格取得": "英語",
  "4技能": "英語",
  "メタバース・XR・AIアワード": "メタバース",
  "マンスリースマホ": "端末",
  "マンスリータブレット": "端末",
  "タブレット学習": "タブレット",
  "タブレット端末": "タブレット",
  "スマホ": "端末",
  "端末管理サポート": "端末",
  "電子機器": "ICT活用",
  "入退室管理": "塾運営",
  "請求管理": "塾運営",
  "経費削減": "塾経営",
  "コストカット": "塾経営",
  "コスト削減": "塾経営",
  "法人税対策": "塾経営",
  "節税対策": "塾経営",
  "財務計画": "塾経営",
  "経営基盤": "塾経営",
  "経営安定化": "塾経営",
  "経営戦略": "塾経営",
  "経営課題": "塾経営",
  "安定した塾経営": "塾経営",
  "成功する塾": "塾経営",
  "生き残り": "塾経営",
  "競争力強化": "塾経営",
  "差別化": "塾経営",
  "市場動向": "塾経営",
  "業界動向": "塾経営",
  "口コミ対策": "口コミ",
  "評判対策": "口コミ",
  "不当な口コミ": "口コミ",
  "クレーム対応": "保護者対応",
  "保護者目線": "保護者対応",
  "顧客目線": "塾経営",
  "顧客ニーズ": "塾経営",
  "顧客価値": "塾経営",
  "顧客満足度向上": "塾経営",
  "信頼構築": "信頼",
  "伴走者": "教育",
  "現場ノウハウ": "教育",
  "実践事例": "成功事例",
  "事例紹介": "成功事例",
  "アップデート情報": "アップデート",
  "新機能": "アップデート",
  "紹介キャンペーン": "キャンペーン",
  "参加特典": "キャンペーン",
  "使い放題キャンペーン": "キャンペーン",
  "無料トライアル": "無料セミナー",
  "無償提供プログラム": "無償提供",
  "導入費無料": "無償提供",
  "初期費用不要": "無償提供",
  "柔軟な料金プラン": "価格設定",
  "授業料設定": "価格設定",
  "授業料値上げ": "価格設定",
  "費用比較": "費用対効果",
  "導入コスト": "塾経営",
  "成果報酬型": "塾経営",
  "成約課金型": "塾経営",
  "塾探しの窓口": "集客",
  "ポータルサイト業界": "ポータルサイト",
  "海外教育": "教育",
  "グローバル教育": "教育",
  "国際バカロレア": "教育",
  "万博": "EXPO2025",
  "こども万博": "EXPO2025",
  "令和7年度": "2025年度",
  "令和の虎": "教育",
  // 都道府県の表記ゆれ（短縮・略称 → 正式名「〇〇県/都/府」）
  "和歌山": "和歌山県",
  "大阪": "大阪府",
  "東京": "東京都",
  "沖縄": "沖縄県",
  "札幌": "北海道",
  "神戸": "兵庫県",
  "名古屋": "愛知県",
  "青森": "青森県",
  "岩手": "岩手県",
  "宮城": "宮城県",
  "秋田": "秋田県",
  "山形": "山形県",
  "福島": "福島県",
  "茨城": "茨城県",
  "栃木": "栃木県",
  "群馬": "群馬県",
  "埼玉": "埼玉県",
  "千葉": "千葉県",
  "神奈川": "神奈川県",
  "新潟": "新潟県",
  "富山": "富山県",
  "石川": "石川県",
  "福井": "福井県",
  "山梨": "山梨県",
  "長野": "長野県",
  "岐阜": "岐阜県",
  "静岡": "静岡県",
  "愛知": "愛知県",
  "三重": "三重県",
  "滋賀": "滋賀県",
  "京都": "京都府",
  "奈良": "奈良県",
  "鳥取": "鳥取県",
  "島根": "島根県",
  "岡山": "岡山県",
  "広島": "広島県",
  "山口": "山口県",
  "徳島": "徳島県",
  "香川": "香川県",
  "愛媛": "愛媛県",
  "高知": "高知県",
  "福岡": "福岡県",
  "佐賀": "佐賀県",
  "長崎": "長崎県",
  "熊本": "熊本県",
  "大分": "大分県",
  "宮崎": "宮崎県",
  "鹿児島": "鹿児島県",
  // より多くの派生タグを代表タグに統合
  // DX系
  "DX推進": "DX",
  "教育DX": "DX",
  "校務DX": "DX",
  // デジタル系
  "デジタルツール": "デジタル教育",
  "デジタル教科書": "デジタル教育",
  "デジタル戦略": "デジタル教育",
  "デジタル庁": "デジタル教育",
  "デジ活": "デジタル教育",
  "デジタル学習国際フォーラム": "デジタル教育",
  "デジタル・ナレッジ": "デジタル教育",
  "完全デジタル化": "デジタル教育",
  // セミナー・イベント系
  "ウェビナー": "セミナー",
  "無料セミナー": "セミナー",
  "セミナー・イベント": "セミナー",
  // コーチング系
  "コーチング技術": "コーチング",
  "コーチング研修": "コーチング",
  "コーチング思考": "コーチング",
  "コーチングスタディ": "コーチング",
  // 学習系
  "学習意欲": "学習",
  "学習意欲向上": "学習",
  "学習指導要領": "学習",
  "学習支援": "学習",
  "学習塾": "塾",
  "家庭学習": "学習",
  "家庭学習支援": "学習",
  "自宅学習": "学習",
  "パソコン学習": "学習",
  "タブレット学習": "タブレット",
  "小学生学習": "小学生",
  "中学生学習": "中学生",
  // 入試・受験系
  "入試対策": "入試",
  "入試改革": "入試",
  "入試環境": "入試",
  "入試不正": "入試",
  "受験生": "受験",
  "受験うつ": "受験",
  "受験の偏差値": "受験",
  "受験成功": "受験",
  "受験生の志望理由": "受験",
  "受験軸": "受験",
  "志望校のきっかけ": "受験",
  "志望理由書": "受験",
  "合格": "受験",
  "合格ライン": "受験",
  "合格支援": "受験",
  // 大学系
  "大学生": "大学",
  "大学選び": "大学",
  "大学再編": "大学",
  "大学統合": "大学",
  "大学入学共通テスト": "大学入試",
  "大学法人法": "大学",
  // 高校系
  "高校教育": "高校",
  "高校生": "高校",
  "高校中退": "高校",
  "高校部": "高校",
  "高校連携": "高校",
  "高校入試": "入試",
  "公立高校入試": "入試",
  // 中学系
  "中学校": "中学",
  "中学生": "中学",
  "中学受験": "受験",
  "中学生学習": "中学",
  "小中学校": "中学",
  // 小学校系
  "小学生": "小学校",
  "小学生学習": "小学校",
  "小学生探究教育": "小学校",
  "小学校受験": "受験",
  "公立小学校": "小学校",
  // 英語系
  "英語教育": "英語",
  "英会話": "英語",
  "英検": "英語",
  "英検対策": "英語",
  "英作文": "英語",
  "英国": "イギリス",
  // プログラミング系
  "プログラミング教育": "プログラミング",
  "プログラミング教室": "プログラミング",
  "プログラミング未経験": "プログラミング",
  // 探究系
  "探究学舎": "探究教育",
  "探究・キャリア教育": "探究教育",
  "総合的な探究": "探究教育",
  "小学生探究教育": "探究教育",
  // 保護者系
  "保護者対応": "保護者",
  "保護者連携": "保護者",
  "保護者連絡": "保護者",
  "保護者目線": "保護者",
  "親のプレッシャー": "保護者",
  "親の承認力": "保護者",
  "親の心を動かす質問": "保護者",
  "親子サポート": "保護者",
  // メンタルヘルス系
  "メンタルサポート": "メンタルヘルス",
  "メンタル不調防止": "メンタルヘルス",
  "心のケア": "メンタルヘルス",
  "心理カウンセリング": "メンタルヘルス",
  "心理的サポート": "メンタルヘルス",
  "ストレスマネジメント": "メンタルヘルス",
  // 不登校系
  "不登校支援": "不登校",
  "出席扱い認定": "不登校",
  // 教材系
  "教材": "教材",
  "教科書": "教材",
  "デジタル教科書": "教材",
  "小学校教科書": "教材",
  "教科書ナビ": "教材",
  "教科書改訂": "教材",
  "教科書準拠": "教材",
  "検定教科書準拠": "教材",
  "ゲーム型教材": "教材",
  "ICT教材": "教材",
  // 講師・教員系
  "講師研修": "教員研修",
  "講師採用": "教員研修",
  "講師不足": "教員研修",
  "講師管理": "教員研修",
  "講師環境改善": "教員研修",
  "講師用マニュアル": "教員研修",
  "講師研修の方法": "教員研修",
  "教師": "教員",
  "教師研修": "教員研修",
  "教師研修プログラム": "教員研修",
  "教師向けAIツール": "教員研修",
  "教師の成長": "教員研修",
  "教師の人間力": "教員研修",
  "教師と生徒の関係": "教員研修",
  "教師インターンシップ": "教員研修",
  "教師労働環境": "教員研修",
  "先生": "教員",
  // キャンペーン系
  "紹介キャンペーン": "キャンペーン",
  "参加特典": "キャンペーン",
  "使い放題キャンペーン": "キャンペーン",
  "キックオフ": "キャンペーン",
  // 価格・費用系
  "価格設定": "費用対効果",
  "授業料設定": "費用対効果",
  "授業料値上げ": "費用対効果",
  "費用比較": "費用対効果",
  "導入コスト": "費用対効果",
  "無償提供": "費用対効果",
  "導入費無料": "費用対効果",
  "初期費用不要": "費用対効果",
  "柔軟な料金プラン": "費用対効果",
  "低コスト": "費用対効果",
  "授業料": "費用対効果",
  // テスト・試験系
  "定期テスト": "試験",
  "模擬試験": "試験",
  "模擬試験実施": "試験",
  "確認テスト": "試験",
  "テスト対策": "試験",
  "テスト作成": "試験",
  "簡単テスト作成": "試験",
  // GIGAスクール系（統合済みだが念のため）
  "GIGAスクール構想": "GIGAスクール",
  "GIGAスクール構想第2期": "GIGAスクール",
  // 働き方改革・業務効率系
  "働き方改革": "業務効率化",
  "業務改善助成金": "補助金",
  "校務効率化": "業務効率化",
  // セキュリティ系
  "セキュリティ教育": "セキュリティ対策",
  "セキュリティリスク": "セキュリティ対策",
  "不正アクセス": "セキュリティ対策",
  "情報流出": "セキュリティ対策",
  "個人情報保護": "セキュリティ対策",
  // 連携系
  "学校連携": "連携協定",
  "高校連携": "連携協定",
  "高大連携": "連携協定",
  "産学連携": "連携協定",
  "産学官連携": "連携協定",
  "地域連携": "連携協定",
  "包括連携": "連携協定",
  // リテラシー系
  "メディアリテラシー": "リテラシー教育",
  "ITリテラシー": "リテラシー教育",
  "AIリテラシー": "リテラシー教育",
  // マーケティング・SEO系
  "SEO戦略": "SEO対策",
  "SNSマーケティング": "マーケティング",
  "SNS集客": "集客",
  "WEB集客": "集客",
  "新規生徒獲得": "集客",
  // 指導方法系
  "指導方法": "指導",
  "指導報告書": "指導",
  "指導者向けツール": "指導",
  "生徒指導": "指導",
  "進路指導": "指導",
  "個別指導": "指導",
  "個別指導塾": "塾",
  "一斉個別指導": "指導",
  "一斉授業": "授業",
  "習熟度別指導": "指導",
  "少人数指導": "指導",
  "受験指導": "受験",
  "受験生指導": "受験",
  // 企業・出版社名（有名どころは残すが、派生は統合）
  "ベネッセコーポレーション": "ベネッセ",
  "NECソリューションイノベータ": "NEC",
  "GMOメディア": "GMO",
  "LINEヤフー": "LINE",
  "NTT西日本": "NTT",
  // その他の細かい統合
  "アップデート": "アップデート",
  "アップデート情報": "アップデート",
  "新機能": "アップデート",
  "リニューアル": "アップデート",
  "Z世代": "Z世代",
  "Z世代考察": "Z世代",
  "EdTech": "EdTech",
  "EdTechトレンド": "EdTech",
  "エドテック": "EdTech",
  "コミュニティ": "コミュニティ",
  "地域": "地域",
  "地域貢献": "地域",
  "地域特化": "地域",
  "田舎": "地域",
  "アウトプット": "アウトプット",
  "アウトプット重視の研修": "アウトプット",
  "インプットとアウトプット": "アウトプット",
};

// 2. 除外するタグ（個人名・特定イベント1回限り・ノイズ）
const excludeSet = new Set([
  "佐藤雄太",
  "安井政樹",
  "安藤昇",
  "安野たかひろ",
  "岩井 良明",
  "岡崎朋美",
  "島田陽輔",
  "木村吉宏",
  "松尾豊",
  "濵田英毅",
  "炭谷俊樹",
  "池田朋弘",
  "稲垣忠",
  "藤原和博",
  "野本一真",
  "鈴木秀樹",
  "宇都宮らいく",
  "投稿者名",
  "レイの失踪",
  "前川先生",
  "御上先生",
  "写メQ先生",
  "投稿者名",
  "aim@",
  "ノイズ",
  "癖",
  "元旦",
  "年頭所感",
  "参院選",
  "トランプ",
  "条例案",
  "衆議院第一議員会館",
  "学校現場のAI活用実践コンテスト2025",
  "教育関係者向け 探究・校務改革支援補助金2025",
  "探究・校務改革支援補助金2025",
  "最終選考会",
  "実況",
  "総括",
  "いけとも",
  // 塾の〇〇 細かいノウハウ系（汎用の「塾経営」「塾運営」「面談」等で代用）
  "塾の入塾面談成功法",
  "塾の面談の極意",
  "塾の成功法則",
  "塾の利益構造",
  "塾の役割",
  "塾の教育方針",
  "塾の未来",
  "塾の競争力",
  "塾の経費管理",
  "塾の連絡帳",
  "塾の集客方法",
  "塾の面談対策",
  "塾のカリキュラム変革",
  "塾の保護者対応",
  "塾の入塾相談",
  "塾経営のコツ",
  "塾運営のベストプラクティス",
  "塾選びのコツ",
  "塾面談成功事例",
  "入塾率を上げる秘訣",
  "志望校選びのコツ",
  "三者面談で使える質問",
  "三者面談質問例",
  "面談で親を落とすテクニック",
  "親を説得する方法",
]);

// 3. 地域: 都道府県は残す。市区町村・小地域は除外（「〇〇市」「〇〇区」「〇〇町」）
const prefectures = new Set([
  "北海道", "青森県", "岩手県", "宮城県", "秋田県", "山形県", "福島県",
  "茨城県", "栃木県", "群馬県", "埼玉県", "千葉県", "東京都", "神奈川県",
  "新潟県", "富山県", "石川県", "福井県", "山梨県", "長野県", "岐阜県",
  "静岡県", "愛知県", "三重県", "滋賀県", "京都府", "大阪府", "兵庫県",
  "奈良県", "和歌山県", "鳥取県", "島根県", "岡山県", "広島県", "山口県",
  "徳島県", "香川県", "愛媛県", "高知県", "福岡県", "佐賀県", "長崎県",
  "熊本県", "大分県", "宮崎県", "鹿児島県", "沖縄県",
]);
function isSmallRegion(name) {
  if (prefectures.has(name)) return false;
  if (/^.+(市|区|町|村)$/.test(name)) return true;
  return false;
}

// 4. 株式会社〇〇 / 合同会社〇〇 は除外（サービス名は「すらら」など別タグで残っている想定）
function isDroppableCompany(name) {
  return /^株式会社/.test(name) || /^合同会社/.test(name);
}

// 5. 特定の大学名・高校名・学校法人名（汎用の「大学」「高校」は残す）
function isSpecificSchool(name) {
  if (name === "大学" || name === "高校" || name === "小学校" || name === "中学校" || name === "専門学校") return false;
  if (/大学$/.test(name) || /高校$/.test(name) || /高等学校$/.test(name) || /学園$/.test(name) || /学院$/.test(name)) return true;
  return false;
}

// 6. 長すぎるタグ（30文字超）で明らかに1回限りのものは除外
function isTooLongOneOff(name) {
  return name.length > 30;
}

// 適用
const seen = new Set();
const result = [];

for (const t of tags) {
  let tag = normalizeMap[t] ?? t;
  if (excludeSet.has(tag)) continue;
  if (isSmallRegion(tag)) continue;
  if (isDroppableCompany(tag)) continue;
  if (isSpecificSchool(tag)) continue;
  if (isTooLongOneOff(tag)) continue;
  if (seen.has(tag)) continue;
  seen.add(tag);
  result.push(tag);
}

result.sort((a, b) => a.localeCompare(b, "ja"));

// シードSQL生成
function esc(s) {
  return s.replace(/'/g, "''");
}
const values = result.map((name, i) => `  ('${esc(name)}', ${i})`).join(",\n");
const sql = `-- ArticleTag 最適化版（${result.length}件）
-- 年・年度の統一、表記ゆれ統合、個人名・細かい地域・一部企業名を除外済み

INSERT INTO public."ArticleTag" ("name", "sort_order")
VALUES
${values}
ON CONFLICT ("name") DO NOTHING;
`;

const outPath = path.join(__dirname, "../supabase/migrations/seed_article_tags.sql");
fs.writeFileSync(outPath, sql);

// 最適化リストを data にも保存
const optimizedListPath = path.join(__dirname, "../data/article-tags-optimized.txt");
fs.writeFileSync(optimizedListPath, result.join("\n") + "\n");

// src/lib/article-tags.ts を最適化リストで上書き（アプリのタグ選択肢を統一）
const tsLines = result.map((s) => `  "${s.replace(/\\/g, "\\\\").replace(/"/g, '\\"')}"`);
const tsContent = `/** 記事カテゴリ = WordPress のタグ（post_tag）。最適化版（年・年度統一・表記ゆれ統合・除外済み） */
export const ARTICLE_TAG_VALUES = [\n${tsLines.join(",\n")}\n] as const;

export const ARTICLE_CATEGORIES = ARTICLE_TAG_VALUES.map((value) => ({ value, label: value }));

export const ARTICLE_CATEGORY_VALUES = [...ARTICLE_TAG_VALUES];

/**
 * CSV/TSV のタグ列がタブ区切りで複数ある場合、先頭のタグを返す（一覧に含まれる場合）
 */
export function parseArticleCategoryFromTsv(cell: string | null | undefined): string {
  if (cell == null || !String(cell).trim()) return "未分類";
  const first = String(cell).split(/\\t/)[0]?.trim();
  const set = new Set(ARTICLE_TAG_VALUES);
  return first && set.has(first) ? first : "未分類";
}
`;
const tsPath = path.join(__dirname, "../src/lib/article-tags.ts");
fs.writeFileSync(tsPath, tsContent);

console.log("Before:", tags.length);
console.log("After:", result.length);
console.log("Removed:", tags.length - result.length);
console.log("Written:", outPath);
console.log("List:", optimizedListPath);
console.log("TypeScript:", tsPath);
