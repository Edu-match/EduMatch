/**
 * アプリのサービスカテゴリ一覧（lib/categories.ts の SERVICE_CATEGORY_VALUES と一致させる）
 */
const SERVICE_CATEGORY_VALUES: readonly string[] = [
  "映像授業",
  "問題演習",
  "AI活用",
  "学習管理システム（LMS）",
  "オンライン授業支援",
  "家庭学習支援",
  "保護者連絡",
  "生徒管理",
  "生徒集客",
  "プログラミング",
  "知育/能力開発/幼児教育",
  "英会話",
  "講師採用/育成/研修",
  "探求・キャリア教育/総合型選抜対策",
  "コンサル/フランチャイズ/M&A",
  "質問対応",
  "デバイス・ハードウェア・ICT環境構築",
  "その他管理/代行",
  "助成金・補助金支援",
  "AI活用 > 問題演習（生徒が使用する）",
  "AI活用 > 業務効率化（先生が使用する）",
  "その他管理/代行 > 月謝管理",
  "オンライン授業支援 > オンライン授業ツール",
  "オンライン授業支援 > オンライン授業立ち上げ支援",
  "コンサル/フランチャイズ/M&A > FC加盟",
  "コンサル/フランチャイズ/M&A > M&A（塾売却）",
  "コンサル/フランチャイズ/M&A > オンライン授業立ち上げ支援",
  "コンサル/フランチャイズ/M&A > コンサルタント",
  "デバイス・ハードウェア・ICT環境構築 > ICT構築",
  "デバイス・ハードウェア・ICT環境構築 > 業務効率化（先生が使用する）",
  "問題演習 > アナログ教材",
  "問題演習 > デジタル教材",
  "問題演習 > 映像授業（単科目）",
  "映像授業 > 映像授業作成",
  "映像授業 > 映像授業（5教科対応）",
  "映像授業 > 映像授業（単科目）",
  "生徒集客 > HP作成",
  "生徒集客 > SNS",
  "生徒集客 > YouTube",
  "生徒集客 > デジタル教材",
  "生徒集客 > 代行サービス",
  "生徒集客 > 塾ポータル",
  "生徒集客 > 業務効率化（先生が使用する）",
  "英会話 > オンラインリアル英会話",
  "英会話 > オンライン授業立ち上げ支援",
  "英会話 > 映像授業（単科目）",
  "講師採用/育成/研修 > 代行サービス",
  "講師採用/育成/研修 > 月謝管理",
  "講師採用/育成/研修 > 講師採用ポータル",
  "講師採用/育成/研修 > 講師管理",
  "講師採用/育成/研修 > 講師育成/研修",
  "その他",
];

/**
 * CSVのカテゴリ文字列（カンマ区切り・階層付き）をアプリの単一カテゴリに正規化する。
 * カンマで分割し、各セグメントをトリムしてから、一覧に含まれるものがあればそのまま返す。
 * どれも一致しなければ「その他」を返す。
 */
export function normalizeServiceCategory(raw: string | null): string {
  if (!raw || !raw.trim()) return "その他";
  const set = new Set(SERVICE_CATEGORY_VALUES);
  const segments = raw.split(",").map((s) => s.trim()).filter(Boolean);
  for (const seg of segments) {
    if (set.has(seg)) return seg;
    const sub = seg.split(/\s*>\s*/).map((s) => s.trim());
    for (const part of sub) {
      if (set.has(part)) return part;
    }
  }
  return "その他";
}
